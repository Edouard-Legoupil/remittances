<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://d3js.org/d3.geo.projection.v0.min.js"></script>
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <!--
Remittances:
"Source: World Bank staff calculation based on data from IMF Balance of Payments Statistics Yearbook 2012 and data releases from central banks, national statistical agencies, and World Bank country desks. See Migration and Development Brief 12 for the methodology for the forecasts.",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
Note: All numbers are in current (nominal) US $.,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
"For a discussion of the definition of remittances, see Dilip Ratha, 2003, ""Workers' Remittances: An Important and Stable Source of External Development Finance"", Global Development Finance 2003, World Bank.",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
GDP data is from WDI 2012
-->
  </head>
  </head>
  <body>
    <div id="chart"></div>
    <div id="legend"></div>
    <script>

var width = 960,
    height = 500;

var svg = d3.select("body").append("svg")
  .attr("width", width)
  .attr("height", height);


var projection = d3.geo.projection(d3.geo.hammer.raw(1.75, 2))
    .rotate([-10, -45])
    .scale(180);

//var projection = d3.geo.winkel3();

var path = d3.geo.path()
    .projection(projection);

var nameColumn = "Migrant remittance Inflows (US$ million)";

d3.json("data/world-countries.json", function(error, world) {

  var featuresByName = {}, f;
  for (var d in world.features) {
    f = world.features[d];
    featuresByName[f.properties.name] = f;
  }



  var years = [
    "1970","1971","1972","1973","1974","1975","1976","1977","1978","1979","1980",
    "1981","1982","1983","1984","1985","1986","1987","1988","1989","1990","1991",
    "1992","1993","1994","1995","1996","1997","1998","1999","2000","2001","2002",
    "2003","2004","2005","2006","2007","2008",
    "2009","2010","2011","2012e",
  ];

  d3.csv("data/RemittancesData_Inflows_Nov12.csv", function(error, remittances) {
    var name, r;
    remittances.forEach(function(r) {
      f = featuresByName[r.Name];
      if (f) {
        r.centroid = path.centroid(f);
      }

      for (i in years) {
        y = years[i];
        if (r[y] !== undefined)
          r[y] = +r[y].replace(",","")
      }
    });

    svg.append("g")
       .attr("class", "map")
      .selectAll("path")
        .data(world.features)
        .enter().append("path")
        .attr("class", "land")
        .attr("d", path);


    var gcountries = svg.append("g")
       .attr("class", "countries");



    var selectedYear = "2005";

    var max = d3.max(remittances, function(d) {
        //console.log(d[selectedYear])
        return d[selectedYear];
      });

      console.log("max: " + max)

    var rscale = d3.scale.sqrt()
      .range([0, 15])
      .domain([0, max])



    circles = gcountries.selectAll("circle")
        .data(remittances)
      .enter().append("svg:circle")
        .attr("class", "country")
        .attr("cx", function(d) { if (d.centroid) return d.centroid[0] })
        .attr("cy", function(d) { if (d.centroid) return d.centroid[1] })
        .attr("opacity", 0)
        .append("svg:title")
          .text(function(d) { return d.Name + ": " + d[selectedYear] + " US$ million"});


//        .attr(function(d) {
//          console.log(d.Name);
//          featuresByName[d.Name]
//          var c = path.centroid();
//          return {
//            "class": "remittance",
//            "cx": ""
//          }});


    function update(start) {
      var c = gcountries.selectAll("circle")
      if (!start)
         c = c.transition()
          .duration(start ? 0 : 100)

      c.attr("r", function(d) { return rscale(d[selectedYear]); })
    }


    update(true);

     gcountries.selectAll("circle")
      .transition()
        .duration(300)
        .attr("opacity", 1)

    var yearLen = 10;

    yearsg = svg.append("g")
      .attr("class", "years")
     .attr("transform", "translate("+((width - years.length*yearLen)/2)+","+(height)+")")


    yearsg.selectAll("text")
        .data(years)
        .enter()
        .append("svg:text")
          .attr("visibility", function(d,i) {
            if ((parseInt(d) % 5) == 0)
              return  "visible"
           else return "hidden";
          })
          .attr("y", 0)
          .attr("x", function(d, i) { return i*yearLen; })
          .attr("text-anchor", "middle")
          .text(function(d) { return d; })
          .on("mouseover", function(d) {
            selectedYear = d;
            update();
          });


  });

  // Migrant remittance Inflows (US$ million)

});

    </script>
  </body>
</html>
